name: Deploy to Heroku

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku login --api-key=$HEROKU_API_KEY
      
      - name: Create/Deploy app to Heroku
        env:
          HEROKU_APP_NAME: weekday-interview-scheduler
        run: |
          if heroku apps:info $HEROKU_APP_NAME 2>/dev/null; then
            echo "App exists, updating..."
            git push https://git.heroku.com/$HEROKU_APP_NAME.git main
          else
            echo "Creating new app..."
            heroku create $HEROKU_APP_NAME
            git push https://git.heroku.com/$HEROKU_APP_NAME.git main
          fi
      
      - name: Set environment variables
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: weekday-interview-scheduler
        run: |
          heroku config:set MAILERSEND_API_KEY=${{ secrets.MAILERSEND_API_KEY }} --app=$HEROKU_APP_NAME
          heroku config:set NODE_ENV=production --app=$HEROKU_APP_NAME

      - name: Run database migrations
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: weekday-interview-scheduler
        run: heroku run "npm start" --app=$HEROKU_APP_NAME --exit-code
